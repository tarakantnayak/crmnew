'use strict';

jQuery.Class('Calendar_CalendarView_Js',{currentInstance:!1,getInstanceByView:function d(){var a,b=jQuery('#currentView').val(),c=b+'_'+(b+'View')+'_Js';return a='undefined'==typeof window[c]?new Calendar_CalendarView_Js:new window[c],a},registerColorField:function d(a,b){var c={};c.dropdownCss={"z-index":0},c.formatSelection=function(c,d){var e=c.id,f=a.find('option[value="'+e+'"]');d.addClass(b+'_'+e);var g='<div>'+f.text()+'</div>';return g},App.Fields.Picklist.changeSelectElementView(a,'select2',c);}},{calendarView:!1,calendarCreateView:!1,renderCalendar:function e(){var a=this,b=app.getMainParams('eventLimit');b=!('true'!=b)||'false'!=b&&parseInt(b)+1;var c=app.getMainParams('weekView'),d=app.getMainParams('dayView'),f=app.getMainParams('activity_view');f='Today'==f?d:'This Week'==f?c:'month';var g=app.moduleCacheGet('defaultView');null!=g&&(f=g);var h=app.getMainParams('time_format');h=24==h?'H:mm':'h:mmt';var i=CONFIG.firstDayOfWeekNo,j=app.getMainParams('start_hour')+':00',k=[];'workDays'==app.getMainParams('switchingDays')&&(k=app.getMainParams('hiddenDays',!0));var l={header:{left:'month,'+c+','+d,center:'title today',right:'prev,next'},timeFormat:h,axisFormat:h,scrollTime:j,firstDay:i,defaultView:f,editable:!0,slotMinutes:15,defaultEventMinutes:0,forceEventDuration:!0,defaultTimedEventDuration:'01:00:00',eventLimit:b,selectable:!0,selectHelper:!0,hiddenDays:k,height:app.setCalendarHeight(),views:{basic:{eventLimit:!1}},select:function d(b,c){a.selectDays(b,c),a.getCalendarView().fullCalendar('unselect');},eventDrop:function e(b,c,d){a.updateEvent(b,c,d);},eventResize:function e(b,c,d){a.updateEvent(b,c,d);},eventRender:function d(a,b){var c='';''!==a.vis&&(c=app.vtranslate('JS_'+a.vis)),app.showPopoverElementView(b.find('.fc-content'),{title:a.title+'<a href="index.php?module='+a.module+'&view=Edit&record='+a.id+'" class="float-right"><span class="fas fa-edit"></span></a><a href="index.php?module='+a.module+'&view=Detail&record='+a.id+'" class="float-right mx-1"><span class="fas fa-th-list"></span></a>',container:'body',html:!0,placement:'auto',template:'<div class="popover calendarPopover" role="tooltip"><div class="arrow"></div><h3 class="popover-header"></h3><div class="popover-body"></div></div>',content:'<div><span class="far fa-clock"></span> <label>'+app.vtranslate('JS_START_DATE')+'</label>: '+a.start_display+'</div><div><span class="far fa-clock"></span> <label>'+app.vtranslate('JS_END_DATE')+'</label>: '+a.end_display+'</div>'+(a.lok?'<div><span class="fas fa-globe"></span> <label>'+app.vtranslate('JS_LOCATION')+'</label>: '+a.lok+'</div>':'')+(a.pri?'<div><span class="fas fa-exclamation-circle"></span> <label>'+app.vtranslate('JS_PRIORITY')+'</label>: '+app.vtranslate('JS_'+a.pri)+'</div>':'')+'<div><span class="fas fa-question-circle"></span> <label>'+app.vtranslate('JS_STATUS')+'</label>: '+app.vtranslate('JS_'+a.sta)+'</div>'+(a.accname?'<div><span class="userIcon-Accounts" aria-hidden="true"></span> <label>'+app.vtranslate('JS_ACCOUNTS')+'</label>: '+a.accname+'</div>':'')+(a.linkexl?'<div><span class="userIcon-'+a.linkexm+'" aria-hidden="true"></span> <label>'+app.vtranslate('JS_RELATION_EXTEND')+'</label>: <a target="_blank" href="index.php?module='+a.linkexm+'&view=Detail&record='+a.linkextend+'">'+a.linkexl+'</a></div>':'')+(a.linkl?'<div><span class="userIcon-'+a.linkm+'" aria-hidden="true"></span> <label>'+app.vtranslate('JS_RELATION')+'</label>: <a target="_blank" href="index.php?module='+a.linkm+'&view=Detail&record='+a.link+'">'+a.linkl+'</a></div>':'')+(a.procl?'<div><span class="userIcon-'+a.procm+'" aria-hidden="true"></span> <label>'+app.vtranslate('JS_PROCESS')+'</label>: <a target="_blank" href="index.php?module='+a.procm+'&view=Detail&record='+a.process+'">'+a.procl+'</a></div>':'')+(a.subprocl?'<div><span class="userIcon-'+a.subprocm+'" aria-hidden="true"></span> <label>'+app.vtranslate('JS_SUB_PROCESS')+'</label>: <a target="_blank" href="index.php?module='+a.subprocm+'&view=Detail&record='+a.subprocess+'">'+a.subprocl+'</a></div>':'')+(a.state?'<div><span class="far fa-star"></span> <label>'+app.vtranslate('JS_STATE')+'</label>: '+app.vtranslate(a.state)+'</div>':'')+'<div><span class="fas fa-eye"></span> <label>'+app.vtranslate('JS_VISIBILITY')+'</label>: '+c+'</div>'+(a.smownerid?'<div><span class="fas fa-user"></span> <label>'+app.vtranslate('JS_ASSIGNED_TO')+'</label>: '+a.smownerid+'</div>':'')});},eventClick:function f(a,b){b.preventDefault();var c=new URL($(this)[0].href),d=jQuery.progressIndicator({blockInfo:{enabled:!0}}),e='index.php?module=Calendar&view=ActivityStateModal&record='+c.searchParams.get('record');app.showModalWindow({url:e,cb:function a(){d.progressIndicator({mode:'hide'});}});},monthNames:[app.vtranslate('JS_JANUARY'),app.vtranslate('JS_FEBRUARY'),app.vtranslate('JS_MARCH'),app.vtranslate('JS_APRIL'),app.vtranslate('JS_MAY'),app.vtranslate('JS_JUNE'),app.vtranslate('JS_JULY'),app.vtranslate('JS_AUGUST'),app.vtranslate('JS_SEPTEMBER'),app.vtranslate('JS_OCTOBER'),app.vtranslate('JS_NOVEMBER'),app.vtranslate('JS_DECEMBER')],monthNamesShort:[app.vtranslate('JS_JAN'),app.vtranslate('JS_FEB'),app.vtranslate('JS_MAR'),app.vtranslate('JS_APR'),app.vtranslate('JS_MAY'),app.vtranslate('JS_JUN'),app.vtranslate('JS_JUL'),app.vtranslate('JS_AUG'),app.vtranslate('JS_SEP'),app.vtranslate('JS_OCT'),app.vtranslate('JS_NOV'),app.vtranslate('JS_DEC')],dayNames:[app.vtranslate('JS_SUNDAY'),app.vtranslate('JS_MONDAY'),app.vtranslate('JS_TUESDAY'),app.vtranslate('JS_WEDNESDAY'),app.vtranslate('JS_THURSDAY'),app.vtranslate('JS_FRIDAY'),app.vtranslate('JS_SATURDAY')],dayNamesShort:[app.vtranslate('JS_SUN'),app.vtranslate('JS_MON'),app.vtranslate('JS_TUE'),app.vtranslate('JS_WED'),app.vtranslate('JS_THU'),app.vtranslate('JS_FRI'),app.vtranslate('JS_SAT')],buttonText:{today:app.vtranslate('JS_TODAY'),month:app.vtranslate('JS_MONTH'),week:app.vtranslate('JS_WEEK'),day:app.vtranslate('JS_DAY')},allDayText:app.vtranslate('JS_ALL_DAY'),eventLimitText:app.vtranslate('JS_MORE')};if(null!=app.moduleCacheGet('start')){var m=moment(app.moduleCacheGet('start')).valueOf(),n=moment(app.moduleCacheGet('end')).valueOf();l.defaultDate=moment(moment(m+(n-m)/2).format('YYYY-MM-DD'));}a.getCalendarView().fullCalendar('destroy'),a.getCalendarView().fullCalendar(l),a.createAddSwitch();},getValuesFromSelect2:function f(a,b,c){if(a.hasClass('select2-hidden-accessible'))for(var d=a.select2('data'),e=0;e<d.length;e++)c?b.push(d[e].text):b.push(d[e].id);return b},registerButtonSelectAll:function b(){var a=$('.selectAllBtn');a.on('click',function(){var a=$(this).find('.selectAll'),b=$(this).find('.deselectAll');a.hasClass('d-none')?(a.removeClass('d-none'),b.addClass('d-none'),$(this).closest('.quickWidget').find('select option').prop('selected',!1)):($(this).closest('.quickWidget').find('select option').prop('selected',!0),b.removeClass('d-none'),a.addClass('d-none')),$(this).closest('.quickWidget').find('select').trigger('change');});},loadCalendarData:function j(a){var b=jQuery.progressIndicator({blockInfo:{enabled:!0}}),c=this;c.getCalendarView().fullCalendar('removeEvents');var d=c.getCalendarView().fullCalendar('getView'),e=[],f=CONFIG.dateFormat.toUpperCase();e=c.getValuesFromSelect2($('#calendarActivityTypeList'),e),0==e.length&&(a=!0);var g=[];g=c.getValuesFromSelect2($('#calendarUserList'),g),0==g.length&&(g=[CONFIG.userId]),g=c.getValuesFromSelect2($('#calendarGroupList'),g);var h=[];if($('.calendarFilters .filterField').each(function(){var a,b,c=$(this);'checkbox'==c.attr('type')?(a=c.val(),b=c.prop('checked')?1:0):(a=c.attr('name'),b=c.val()),h.push({name:a,value:b});}),!0==a||0<e.length){var i={module:'Calendar',action:'Calendar',mode:'getEvents',start:d.start.format(f),end:d.end.format(f),user:g,time:app.getMainParams('showType'),types:e,filters:h};AppConnector.request(i).done(function(a){c.getCalendarView().fullCalendar('addEventSource',a.result),b.progressIndicator({mode:'hide'});});}else c.getCalendarView().fullCalendar('removeEvents'),b.progressIndicator({mode:'hide'});},updateEvent:function g(a,b,c){var d=jQuery.progressIndicator({blockInfo:{enabled:!0}}),e=a.start.format(),f={module:'Calendar',action:'Calendar',mode:'updateEvent',id:a.id,start:e,delta:b._data,allDay:a.allDay};AppConnector.request(f).done(function(a){d.progressIndicator({mode:'hide'}),a.result||(Vtiger_Helper_Js.showPnotify(app.vtranslate('JS_NO_EDIT_PERMISSION')),c());}).fail(function(){d.progressIndicator({mode:'hide'}),Vtiger_Helper_Js.showPnotify(app.vtranslate('JS_NO_EDIT_PERMISSION')),c();});},selectDays:function g(a,b){var c=this,d=$('#start_hour').val(),e=$('#end_hour').val();!1==b.hasTime()&&b.add(-1,'days'),a=a.format(),b=b.format();var f=c.getCalendarView().fullCalendar('getView');''==d&&(d='00'),''==e&&(e='00'),this.getCalendarCreateView().done(function(e){if(!(0>=e.length)){if('agendaDay'!=f.name&&'agendaWeek'!=f.name&&(a=a+'T'+d+':00',b=b+'T'+d+':00',a==b)){var g=0;g='Call'==e.find('[name="activitytype"]').val()?e.find('[name="defaultCallDuration"]').val():e.find('[name="defaultOtherEventDuration"]').val(),b=moment(b).add(g,'minutes').toISOString();}var h=e.find('[name="date_start"]').data('dateFormat').toUpperCase(),i=e.find('[name="time_start"]').data('format');if(24==i)var j='HH:mm';else j='hh:mm A';var k=moment(a).format(h),l=moment(a).format(j),m=moment(b).format(h),n=moment(b).format(j);e.find('[name="date_start"]').val(k),e.find('[name="due_date"]').val(m),e.find('[name="time_start"]').val(l),e.find('[name="time_end"]').val(n);var o=new Vtiger_Header_Js;o.handleQuickCreateData(e,{callbackFunction:function b(a){c.addCalendarEvent(a.result);}}),jQuery('.modal-body').css({"max-height":app.getScreenHeight(70)+'px',"overflow-y":'auto'});}});},addCalendarEvent:function l(a){var b=this,c=$('#calendarUserList').val();0===c.length&&(c=[CONFIG.userId.toString()]);var d=$('#calendarGroupList').val();if(!(0>$.inArray(a.assigned_user_id.value,c)&&(0>$.inArray(a.assigned_user_id.value,d)||0===d.length))){var e=b.getValuesFromSelect2($('#calendarActivityTypeList'),[]);if(!(0!==e.length&&0>$.inArray(a.activitytype.value,$('#calendarActivityTypeList').val()))){var f=$('.fc-toolbar .js-switch--label-on').last().hasClass('active'),g=this.getCalendarView(),h=$.inArray(a.activitystatus.value,['PLL_POSTPONED','PLL_CANCELLED','PLL_COMPLETED']);if(!0===f&&0<=h||!0!=f&&-1==h)return !1;var i=g.fullCalendar('moment',a.date_start.value+' '+a.time_start.value),j=g.fullCalendar('moment',a.due_date.value+' '+a.time_end.value),k={id:a._recordId,title:a.subject.display_value,start:i.format(),end:j.format(),url:'index.php?module=Calendar&view=Detail&record='+a._recordId,activitytype:a.activitytype.value,allDay:'on'==a.allday.value,state:a.state.value,vis:a.visibility.value,sta:a.activitystatus.value,className:'ownerCBg_'+a.assigned_user_id.value+' picklistCBr_Calendar_activitytype_'+a.activitytype.value,start_display:a.date_start.display_value+' '+a.time_start.display_value,end_display:a.due_date.display_value+' '+a.time_end.display_value,smownerid:a.assigned_user_id.display_value,pri:a.taskpriority.value,lok:a.location.display_value};this.getCalendarView().fullCalendar('renderEvent',k);}}},getCalendarCreateView:function d(){var a=this,b=jQuery.Deferred();if(!1!==this.calendarCreateView)return b.resolve(this.calendarCreateView.clone(!0,!0)),b.promise();var c=jQuery.progressIndicator({blockInfo:{enabled:!0}});return this.loadCalendarCreateView().done(function(d){c.progressIndicator({mode:'hide'}),a.calendarCreateView=d,b.resolve(d.clone(!0,!0));}).fail(function(a){c.progressIndicator({mode:'hide'}),console.error(a);}),b.promise()},loadCalendarCreateView:function d(){var a=jQuery.Deferred(),b=app.getModuleName(),c=Vtiger_Header_Js.getInstance();return c.getQuickCreateForm('index.php?module='+b+'&view=QuickCreateAjax',b).done(function(b){a.resolve(jQuery(b));}).fail(function(){a.reject();}),a.promise()},getCalendarView:function a(){return !1==this.calendarView&&(this.calendarView=jQuery('#calendarview')),this.calendarView},registerChangeView:function b(){var a=this;a.getCalendarView().find('button.fc-button').on('click',function(){a.loadCalendarData();});},goToRecordsList:function j(a){var b=this,c=b.getValuesFromSelect2($('#calendarActivityTypeList'),[]),d=b.getValuesFromSelect2($('#calendarUserList'),[],!1);d=b.getValuesFromSelect2($('#calendarGroupList'),d,!1);var e=b.getCalendarView().fullCalendar('getView'),f=e.start.format(),g=e.end.format(),h=app.getMainParams('activityStateLabels',!0),i='["activitystatus","e","'+h[app.getMainParams('showType')].join()+'"]';i+=',["date_start","bw","'+f+','+g+'"]',c.length&&(i+=',["activitytype","e","'+c+'"]'),d.length&&(i+=',["assigned_user_id","e","'+d+'"]'),$('.calendarFilters .filterField').each(function(){var a=$(this).attr('type');'checkbox'==a&&$(this).prop('checked')&&(i+=(''==i?'[':',[')+$(this).data('search')+']');}),window.location.href=a+'&search_params=[['+i+']]';},registerAddButton:function b(){var a=this;$('.js-add').on('click',function(){a.getCalendarCreateView().done(function(b){var c=new Vtiger_Header_Js;c.handleQuickCreateData(b,{callbackFunction:function c(b){a.addCalendarEvent(b.result);}});});});},switchTpl:function d(a,b,c){return '<div class="btn-group btn-group-toggle js-switch" data-toggle="buttons">\n\t\t\t\t\t<label class="btn btn-outline-primary js-switch--label-on '+(c?'':'active')+'">\n\t\t\t\t\t\t<input type="radio" name="options" data-on-text="'+a+'" autocomplete="off" '+(c?'':'checked')+'>\n\t\t\t\t\t\t'+a+'\n\t\t\t\t\t</label>\n\t\t\t\t\t<label class="btn btn-outline-primary '+(c?'active':'')+'">\n\t\t\t\t\t\t<input type="radio" name="options" data-off-text="'+b+'" autocomplete="off" '+(c?'checked':'')+'>\n\t\t\t\t\t\t'+b+'\n\t\t\t\t\t</label>\n\t\t\t\t</div>'},createAddSwitch:function f(){var a=this,b=this.getCalendarView(),c=void 0,d=void 0,e=$('<div class="js-calendar-switch-container"></div>').insertAfter(b.find('.fc-center'));c='current'!=app.getMainParams('showType')||'history'==app.moduleCacheGet('defaultShowType'),$(this.switchTpl(app.vtranslate('JS_TO_REALIZE'),app.vtranslate('JS_HISTORY'),c)).prependTo(e).on('change','input',function(b){var c=$(b.currentTarget);'undefined'==typeof c.data('on-text')?'undefined'!=typeof c.data('off-text')&&(app.setMainParams('showType','history'),app.moduleCacheSet('defaultShowType','history')):(app.setMainParams('showType','current'),app.moduleCacheSet('defaultShowType','current')),a.loadCalendarData();}),d='workDays'!==app.getMainParams('switchingDays')||'all'===app.moduleCacheGet('defaultSwitchingDays'),!1!==app.getMainParams('hiddenDays',!0)&&$(this.switchTpl(app.vtranslate('JS_WORK_DAYS'),app.vtranslate('JS_ALL'),d)).prependTo(e).on('change','input',function(b){var c=$(b.currentTarget);'undefined'==typeof c.data('on-text')?'undefined'!=typeof c.data('off-text')&&(app.setMainParams('switchingDays','all'),app.moduleCacheSet('defaultSwitchingDays','all')):(app.setMainParams('switchingDays','workDays'),app.moduleCacheSet('defaultSwitchingDays','workDays')),a.renderCalendar(),a.loadCalendarData();});},registerSelect2Event:function b(){var a=this;$('.siteBarRight .select2').each(function(){var a=$(this).attr('id'),b=app.moduleCacheGet(a),c=$('#'+a);0<c.length&&null!=b&&'SELECT'==c.prop('tagName')&&c.val(b);}),$('.siteBarRight .select2, .siteBarRight .filterField').off('change'),App.Fields.Picklist.showSelect2ElementView($('#calendarUserList')),App.Fields.Picklist.showSelect2ElementView($('#calendarActivityTypeList')),App.Fields.Picklist.showSelect2ElementView($('#calendarGroupList')),$('.siteBarRight .select2, .siteBarRight .filterField').on('change',function(){var b=$(this),c=b.val();null==c&&(c=''),a.loadCalendarData(),'checkbox'==b.attr('type')&&(c=b.is(':checked')),app.moduleCacheSet(b.attr('id'),c);});},registerCacheSettings:function e(){var a=this,b=a.getCalendarView();'all'==app.moduleCacheGet('defaultSwitchingDays')?app.setMainParams('switchingDays','all'):app.setMainParams('switchingDays','workDays'),'history'==app.moduleCacheGet('defaultShowType')?app.setMainParams('showType','history'):app.setMainParams('showType','current'),$('.siteBarRight .filterField').each(function(){var a=$(this).attr('id'),b=app.moduleCacheGet(a),c=$('#'+a);0<c.length&&null!=b&&'checkbox'==c.attr('type')&&c.prop('checked',b);}),b.find('.fc-toolbar .fc-button').on('click',function(a){var c,d,e=$(a.currentTarget);c=b.fullCalendar('getView'),d=c.options,e.hasClass('fc-'+c.name+'-button')?app.moduleCacheSet('defaultView',c.name):(e.hasClass('fc-prev-button')||e.hasClass('fc-next-button')||e.hasClass('fc-today-button'))&&(app.moduleCacheSet('start',c.start.format()),app.moduleCacheSet('end',c.end.format()));});var c=app.moduleCacheKeys();if(0<c.length){var d=$('#moduleCacheAlert');$('.bodyContents').on('Vtiger.Widget.Load.undefined',function(){d.removeClass('d-none');}),d.find('.cacheClear').on('click',function(){app.moduleCacheClear(),d.addClass('d-none'),location.reload();});}},registerLoadCalendarData:function c(){var a=this,b=$('.siteBarRight .widgetContainer').length;$('.bodyContents').on('Vtiger.Widget.Load.undefined',function(){b-=1,0==b&&a.loadCalendarData(!0);});},registerEvents:function a(){this.registerCacheSettings(),this.renderCalendar(),this.registerAddButton(),this.registerLoadCalendarData(),this.registerButtonSelectAll(),this.registerChangeView();}}),jQuery(document).ready(function(){var a=Calendar_CalendarView_Js.getInstanceByView();a.registerEvents(),Calendar_CalendarView_Js.currentInstance=a;});
//# sourceMappingURL=CalendarView.min.js.map
